(function() {
  var Promise, cp, fs, install, minimist, path, paths;

  fs = require("fs-extra");

  cp = require("child_process");

  path = require("path");

  Promise = require("bluebird");

  minimist = require("minimist");

  paths = require("./paths");

  install = require("./install");

  fs = Promise.promisifyAll(fs);

  module.exports = {
    installIfNeeded: function() {
      return install.check();
    },
    install: function() {
      return install["package"].apply(install, arguments);
    },
    cli: function(argv) {
      var opts, pathToApp;
      if (argv == null) {
        argv = [];
      }
      opts = minimist(argv);
      pathToApp = argv[0];
      switch (false) {
        case !opts.install:
          return this.installIfNeeded();
        case !pathToApp:
          return this.open(pathToApp, argv);
        default:
          throw new Error("No path to your app was provided.");
      }
    },
    open: function(appPath, argv, cb) {
      var dest;
      appPath = path.resolve(appPath);
      dest = paths.getPathToResources("app");
      return fs.statAsync(appPath).then(function() {
        return fs.removeAsync(dest);
      }).then(function() {
        return fs.ensureSymlinkAsync(appPath, dest, "dir");
      }).then(function() {
        return cp.spawn(paths.getPathToExec(), argv, {
          stdio: "inherit"
        }).on("close", function(code) {
          if (cb) {
            return cb(code);
          } else {
            return process.exit(code);
          }
        });
      })["catch"](function(err) {
        console.log(err.stack);
        return process.exit(1);
      });
    }
  };

}).call(this);
